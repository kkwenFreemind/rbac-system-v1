openapi: 3.0.3
info:
  title: 租戶管理 API
  description: |
    租戶管理模組提供租戶的完整 CRUD 功能，支援多租戶隔離、自動上下文注入、以及分頁查詢。
    
    ## 核心功能
    - 建立租戶（自動分配租戶 ID）
    - 查詢租戶清單（支援分頁、過濾）
    - 取得租戶詳情
    - 更新租戶資訊
    - 軟刪除租戶
    - 變更租戶狀態
    
    ## 多租戶隔離
    所有 API 要求在 HTTP Header 中提供 `X-Tenant-Id`，系統自動透過 MyBatis 攔截器進行租戶過濾。
    
    ## 認證授權
    所有 API 需要 JWT 認證，並且需要相應的權限：
    - `tenant:create`: 建立租戶
    - `tenant:read`: 查詢租戶
    - `tenant:update`: 更新租戶
    - `tenant:delete`: 刪除租戶
    
  version: 1.0.0
  contact:
    name: RBAC System API Support
    email: support@rbac.local

servers:
  - url: http://localhost:8080/api/v1
    description: 本地開發環境
  - url: https://api-dev.rbac.local/api/v1
    description: 開發環境
  - url: https://api.rbac.local/api/v1
    description: 生產環境

tags:
  - name: Tenant
    description: 租戶管理

security:
  - BearerAuth: []

paths:
  /tenants:
    post:
      tags:
        - Tenant
      summary: 建立租戶
      description: |
        建立新的租戶。租戶 ID 由系統自動生成（Snowflake ID）。
        
        **權限要求**: `tenant:create`
      operationId: createTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTenantRequest'
            examples:
              basic:
                summary: 基礎版租戶
                value:
                  name: Acme Corporation
                  contactEmail: admin@acme.com
                  planType: BASIC
                  description: 重要客戶
              enterprise:
                summary: 企業版租戶
                value:
                  name: TechCorp Ltd
                  contactEmail: it@techcorp.com
                  planType: ENTERPRISE
                  description: 企業級客戶
      responses:
        '200':
          description: 租戶建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_TenantResponse'
              examples:
                success:
                  summary: 成功回應
                  value:
                    success: true
                    code: 200
                    message: 操作成功
                    data:
                      id: 1234567890123456789
                      name: Acme Corporation
                      contactEmail: admin@acme.com
                      planType: BASIC
                      planTypeDescription: 基礎版
                      status: ACTIVE
                      statusDescription: 啟用
                      description: 重要客戶
                      createdAt: '2025-01-15T10:30:00'
                      createdBy: 1000000000000000001
                      updatedAt: '2025-01-15T10:30:00'
                      updatedBy: 1000000000000000001
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: 租戶名稱或郵箱已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
              examples:
                duplicateName:
                  summary: 租戶名稱重複
                  value:
                    success: false
                    code: 409
                    message: 租戶名稱已存在
                    data: null
                duplicateEmail:
                  summary: 郵箱重複
                  value:
                    success: false
                    code: 409
                    message: 聯絡郵箱已存在
                    data: null
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      tags:
        - Tenant
      summary: 查詢租戶清單
      description: |
        分頁查詢租戶清單，支援多條件過濾。
        
        **權限要求**: `tenant:read`
      operationId: listTenants
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: name
          in: query
          description: 租戶名稱（模糊搜尋）
          schema:
            type: string
            example: Acme
        - name: contactEmail
          in: query
          description: 聯絡人郵箱（模糊搜尋）
          schema:
            type: string
            example: admin@
        - name: planType
          in: query
          description: 方案類型
          schema:
            $ref: '#/components/schemas/PlanType'
        - name: status
          in: query
          description: 租戶狀態
          schema:
            $ref: '#/components/schemas/TenantStatus'
        - name: pageNum
          in: query
          description: 頁碼（從 1 開始）
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
        - name: pageSize
          in: query
          description: 每頁筆數
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: orderBy
          in: query
          description: 排序欄位
          schema:
            type: string
            enum: [created_at, updated_at, name]
            default: created_at
            example: created_at
        - name: orderDirection
          in: query
          description: 排序方向
          schema:
            type: string
            enum: [asc, desc]
            default: desc
            example: desc
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_TenantListResponse'
              examples:
                success:
                  summary: 成功回應
                  value:
                    success: true
                    code: 200
                    message: 操作成功
                    data:
                      tenants:
                        - id: 1234567890123456789
                          name: Acme Corporation
                          contactEmail: admin@acme.com
                          planType: BASIC
                          planTypeDescription: 基礎版
                          status: ACTIVE
                          statusDescription: 啟用
                          createdAt: '2025-01-15T10:30:00'
                          createdBy: 1000000000000000001
                          updatedAt: '2025-01-15T10:30:00'
                          updatedBy: 1000000000000000001
                        - id: 1234567890123456790
                          name: TechCorp Ltd
                          contactEmail: it@techcorp.com
                          planType: ENTERPRISE
                          planTypeDescription: 企業版
                          status: ACTIVE
                          statusDescription: 啟用
                          createdAt: '2025-01-14T09:20:00'
                          createdBy: 1000000000000000001
                          updatedAt: '2025-01-14T09:20:00'
                          updatedBy: 1000000000000000001
                      total: 150
                      pageNum: 1
                      pageSize: 20
                      totalPages: 8
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /tenants/{id}:
    get:
      tags:
        - Tenant
      summary: 取得租戶詳情
      description: |
        根據 ID 取得租戶詳細資訊。
        
        **權限要求**: `tenant:read`
      operationId: getTenantById
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: id
          in: path
          required: true
          description: 租戶 ID
          schema:
            type: integer
            format: int64
            example: 1234567890123456789
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_TenantResponse'
              examples:
                success:
                  summary: 成功回應
                  value:
                    success: true
                    code: 200
                    message: 操作成功
                    data:
                      id: 1234567890123456789
                      name: Acme Corporation
                      contactEmail: admin@acme.com
                      planType: BASIC
                      planTypeDescription: 基礎版
                      status: ACTIVE
                      statusDescription: 啟用
                      description: 重要客戶
                      createdAt: '2025-01-15T10:30:00'
                      createdBy: 1000000000000000001
                      updatedAt: '2025-01-15T10:30:00'
                      updatedBy: 1000000000000000001
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 租戶不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
              examples:
                notFound:
                  summary: 租戶不存在
                  value:
                    success: false
                    code: 404
                    message: 租戶不存在
                    data: null
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Tenant
      summary: 更新租戶
      description: |
        更新租戶資訊。僅更新提供的欄位（Patch 語意）。
        
        **權限要求**: `tenant:update`
      operationId: updateTenant
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: id
          in: path
          required: true
          description: 租戶 ID
          schema:
            type: integer
            format: int64
            example: 1234567890123456789
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTenantRequest'
            examples:
              updateName:
                summary: 更新名稱
                value:
                  name: Acme Corporation Updated
              updatePlan:
                summary: 升級方案
                value:
                  planType: PRO
                  description: 已升級至專業版
              suspendTenant:
                summary: 暫停租戶
                value:
                  status: SUSPENDED
                  description: 逾期付款，暫停服務
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_TenantResponse'
              examples:
                success:
                  summary: 成功回應
                  value:
                    success: true
                    code: 200
                    message: 操作成功
                    data:
                      id: 1234567890123456789
                      name: Acme Corporation Updated
                      contactEmail: admin@acme.com
                      planType: PRO
                      planTypeDescription: 專業版
                      status: ACTIVE
                      statusDescription: 啟用
                      description: 已升級至專業版
                      createdAt: '2025-01-15T10:30:00'
                      createdBy: 1000000000000000001
                      updatedAt: '2025-01-16T14:20:00'
                      updatedBy: 1000000000000000001
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 租戶不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
        '409':
          description: 租戶名稱或郵箱衝突
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Tenant
      summary: 刪除租戶
      description: |
        軟刪除租戶。刪除後租戶不可恢復，但資料保留用於稽核。
        
        **權限要求**: `tenant:delete`
        
        **前提條件**:
        - 租戶下無活躍使用者
        - 租戶狀態為 INACTIVE
      operationId: deleteTenant
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: id
          in: path
          required: true
          description: 租戶 ID
          schema:
            type: integer
            format: int64
            example: 1234567890123456789
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
              examples:
                success:
                  summary: 成功回應
                  value:
                    success: true
                    code: 200
                    message: 操作成功
                    data: null
        '400':
          description: 刪除條件不滿足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
              examples:
                hasActiveUsers:
                  summary: 存在活躍使用者
                  value:
                    success: false
                    code: 400
                    message: 租戶下存在活躍使用者，無法刪除
                    data: null
                invalidStatus:
                  summary: 狀態不正確
                  value:
                    success: false
                    code: 400
                    message: 僅能刪除 INACTIVE 狀態的租戶
                    data: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 租戶不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /tenants/{id}/status:
    patch:
      tags:
        - Tenant
      summary: 變更租戶狀態
      description: |
        變更租戶狀態（ACTIVE / SUSPENDED / INACTIVE）。
        
        **權限要求**: `tenant:update`
        
        **狀態轉換規則**:
        - ACTIVE → SUSPENDED / INACTIVE
        - SUSPENDED → ACTIVE / INACTIVE
        - INACTIVE → ACTIVE
      operationId: changeTenantStatus
      parameters:
        - $ref: '#/components/parameters/TenantIdHeader'
        - name: id
          in: path
          required: true
          description: 租戶 ID
          schema:
            type: integer
            format: int64
            example: 1234567890123456789
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: '#/components/schemas/TenantStatus'
                reason:
                  type: string
                  maxLength: 200
                  description: 狀態變更原因
                  example: 逾期付款
            examples:
              suspend:
                summary: 暫停租戶
                value:
                  status: SUSPENDED
                  reason: 逾期付款
              activate:
                summary: 啟用租戶
                value:
                  status: ACTIVE
                  reason: 已完成付款
              deactivate:
                summary: 停用租戶
                value:
                  status: INACTIVE
                  reason: 合約到期
      responses:
        '200':
          description: 狀態變更成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_TenantResponse'
        '400':
          description: 狀態轉換不合法
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
              examples:
                invalidTransition:
                  summary: 不合法的狀態轉換
                  value:
                    success: false
                    code: 400
                    message: 不允許從 INACTIVE 轉換至 SUSPENDED
                    data: null
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: 租戶不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result_Void'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 認證 Token

  parameters:
    TenantIdHeader:
      name: X-Tenant-Id
      in: header
      required: true
      description: 租戶 ID（多租戶隔離）
      schema:
        type: integer
        format: int64
        example: 1234567890123456789

  schemas:
    PlanType:
      type: string
      enum: [FREE, BASIC, PRO, ENTERPRISE]
      description: |
        方案類型:
        - FREE: 免費版（最多 10 使用者）
        - BASIC: 基礎版（最多 50 使用者）
        - PRO: 專業版（最多 200 使用者）
        - ENTERPRISE: 企業版（無限制）
      example: BASIC

    TenantStatus:
      type: string
      enum: [ACTIVE, SUSPENDED, INACTIVE]
      description: |
        租戶狀態:
        - ACTIVE: 啟用（正常使用）
        - SUSPENDED: 暫停（暫時禁止登入）
        - INACTIVE: 停用（長期停用）
      example: ACTIVE

    CreateTenantRequest:
      type: object
      required:
        - name
        - contactEmail
        - planType
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: 租戶名稱（唯一）
          example: Acme Corporation
        contactEmail:
          type: string
          format: email
          maxLength: 255
          description: 聯絡人郵箱（唯一）
          example: admin@acme.com
        planType:
          $ref: '#/components/schemas/PlanType'
        description:
          type: string
          maxLength: 500
          description: 備註說明
          example: 重要客戶

    UpdateTenantRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: 租戶名稱
          example: Acme Corporation Updated
        contactEmail:
          type: string
          format: email
          maxLength: 255
          description: 聯絡人郵箱
          example: new-admin@acme.com
        planType:
          $ref: '#/components/schemas/PlanType'
        status:
          $ref: '#/components/schemas/TenantStatus'
        description:
          type: string
          maxLength: 500
          description: 備註說明
          example: 已升級至專業版

    TenantResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: 租戶 ID
          example: 1234567890123456789
        name:
          type: string
          description: 租戶名稱
          example: Acme Corporation
        contactEmail:
          type: string
          format: email
          description: 聯絡人郵箱
          example: admin@acme.com
        planType:
          $ref: '#/components/schemas/PlanType'
        planTypeDescription:
          type: string
          description: 方案類型描述
          example: 基礎版
        status:
          $ref: '#/components/schemas/TenantStatus'
        statusDescription:
          type: string
          description: 租戶狀態描述
          example: 啟用
        description:
          type: string
          description: 備註說明
          example: 重要客戶
        createdAt:
          type: string
          format: date-time
          description: 建立時間
          example: '2025-01-15T10:30:00'
        createdBy:
          type: integer
          format: int64
          description: 建立人 ID
          example: 1000000000000000001
        updatedAt:
          type: string
          format: date-time
          description: 更新時間
          example: '2025-01-16T14:20:00'
        updatedBy:
          type: integer
          format: int64
          description: 更新人 ID
          example: 1000000000000000001

    TenantListResponse:
      type: object
      properties:
        tenants:
          type: array
          items:
            $ref: '#/components/schemas/TenantResponse'
        total:
          type: integer
          format: int64
          description: 總筆數
          example: 150
        pageNum:
          type: integer
          description: 當前頁碼
          example: 1
        pageSize:
          type: integer
          description: 每頁筆數
          example: 20
        totalPages:
          type: integer
          description: 總頁數
          example: 8

    Result_Void:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
          example: true
        code:
          type: integer
          description: 回應碼
          example: 200
        message:
          type: string
          description: 回應訊息
          example: 操作成功
        data:
          type: object
          nullable: true
          description: 回應資料（無資料時為 null）

    Result_TenantResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
          example: true
        code:
          type: integer
          description: 回應碼
          example: 200
        message:
          type: string
          description: 回應訊息
          example: 操作成功
        data:
          $ref: '#/components/schemas/TenantResponse'

    Result_TenantListResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作是否成功
          example: true
        code:
          type: integer
          description: 回應碼
          example: 200
        message:
          type: string
          description: 回應訊息
          example: 操作成功
        data:
          $ref: '#/components/schemas/TenantListResponse'

  responses:
    BadRequest:
      description: 請求參數錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result_Void'
          examples:
            validationError:
              summary: 驗證錯誤
              value:
                success: false
                code: 400
                message: 租戶名稱不可為空
                data: null

    Unauthorized:
      description: 未認證（JWT Token 無效或過期）
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result_Void'
          examples:
            missingToken:
              summary: 缺少 Token
              value:
                success: false
                code: 401
                message: 未提供認證 Token
                data: null
            invalidToken:
              summary: Token 無效
              value:
                success: false
                code: 401
                message: 認證 Token 無效
                data: null

    Forbidden:
      description: 無權限執行此操作
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result_Void'
          examples:
            noPermission:
              summary: 無權限
              value:
                success: false
                code: 403
                message: 無權限執行此操作
                data: null

    InternalServerError:
      description: 伺服器內部錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result_Void'
          examples:
            serverError:
              summary: 伺服器錯誤
              value:
                success: false
                code: 500
                message: 伺服器內部錯誤
                data: null
