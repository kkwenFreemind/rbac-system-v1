# 數據庫設計文檔

## 1. 概述

本文檔詳細描述多租戶RBAC系統的數據庫設計，包括表結構、索引、關聯關係、以及數據字典。

## 2. 數據庫設計原則

### 2.1 設計原則

1. **規範化設計**：遵循第三範式（3NF），減少數據冗餘
2. **租戶隔離**：所有業務表包含 `tenant_id` 字段
3. **軟刪除**：使用 `deleted` 標記而非物理刪除
4. **審計追蹤**：記錄創建人、創建時間、修改人、修改時間
5. **性能優化**：合理設計索引，考慮查詢效率
6. **擴展性**：預留擴展字段，支持未來需求

### 2.2 命名規範

- **表名**：小寫字母，使用下劃線分隔，前綴 `sys_`
- **字段名**：小寫字母，使用下劃線分隔
- **索引名**：`idx_` + 字段名
- **唯一索引**：`uk_` + 字段名
- **外鍵**：`fk_` + 表名 + 字段名

### 2.3 字段類型規範

| 數據類型 | 使用場景 | 示例 |
|---------|---------|------|
| BIGINT | 主鍵、外鍵、大數值 | id, user_id |
| VARCHAR | 字符串（可變長度） | username, email |
| CHAR | 固定長度字符串 | status_code |
| TEXT | 長文本 | description |
| TINYINT | 布爾值、狀態 | status, deleted |
| INT | 整數 | sort_order, count |
| DATETIME | 日期時間 | created_at |
| DECIMAL | 金額、精確數值 | amount |

## 3. ER圖（實體關係圖）

```
┌──────────────┐
│  sys_tenant  │
│  (租戶表)     │
└──────┬───────┘
       │ 1
       │
       │ N
┌──────▼───────┐        ┌──────────────┐
│   sys_user   │───────▶│sys_department│
│   (用戶表)    │   N:N   │  (部門表)     │
└──────┬───────┘        └──────────────┘
       │ N
       │
       │ N
┌──────▼───────┐        ┌──────────────┐
│sys_user_role │───────▶│   sys_role   │
│(用戶角色關聯) │   N:1   │   (角色表)    │
└──────────────┘        └──────┬───────┘
                               │ N
                               │
                               │ N
                        ┌──────▼─────────────┐
                        │sys_role_permission │
                        │  (角色權限關聯)      │
                        └──────┬─────────────┘
                               │ N
                               │
                               │ 1
                        ┌──────▼───────┐
                        │sys_permission│
                        │  (權限表)     │
                        └──────────────┘
```

## 4. 核心表設計

### 4.1 租戶表（sys_tenant）

**表說明**：存儲租戶基本信息和配置

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_code | VARCHAR | 64 | NO | - | 租戶編碼（唯一） |
| tenant_name | VARCHAR | 128 | NO | - | 租戶名稱 |
| contact_name | VARCHAR | 64 | YES | - | 聯繫人 |
| contact_phone | VARCHAR | 20 | YES | - | 聯繫電話 |
| contact_email | VARCHAR | 100 | YES | - | 聯繫郵箱 |
| package_type | VARCHAR | 32 | YES | 'BASIC' | 套餐類型 |
| max_users | INT | - | YES | 10 | 最大用戶數 |
| max_storage | BIGINT | - | YES | 1073741824 | 最大存儲空間(字節) |
| isolation_level | VARCHAR | 32 | YES | 'ROW' | 隔離級別 |
| db_schema | VARCHAR | 64 | YES | - | 數據庫Schema |
| status | TINYINT | - | YES | 1 | 狀態：0-禁用 1-啟用 |
| expire_time | DATETIME | - | YES | - | 過期時間 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |
| updated_by | BIGINT | - | YES | - | 更新人 |
| updated_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 更新時間 |
| deleted | TINYINT | - | YES | 0 | 刪除標記 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_tenant_code` (`tenant_code`)
- INDEX `idx_status` (`status`)
- INDEX `idx_expire_time` (`expire_time`)

**DDL語句**：

```sql
CREATE TABLE sys_tenant (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '租戶ID',
    tenant_code VARCHAR(64) NOT NULL UNIQUE COMMENT '租戶編碼',
    tenant_name VARCHAR(128) NOT NULL COMMENT '租戶名稱',
    contact_name VARCHAR(64) COMMENT '聯繫人',
    contact_phone VARCHAR(20) COMMENT '聯繫電話',
    contact_email VARCHAR(100) COMMENT '聯繫郵箱',
    package_type VARCHAR(32) DEFAULT 'BASIC' COMMENT '套餐類型',
    max_users INT DEFAULT 10 COMMENT '最大用戶數',
    max_storage BIGINT DEFAULT 1073741824 COMMENT '最大存儲空間',
    isolation_level VARCHAR(32) DEFAULT 'ROW' COMMENT '隔離級別',
    db_schema VARCHAR(64) COMMENT '數據庫Schema',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    expire_time DATETIME COMMENT '過期時間',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    deleted TINYINT DEFAULT 0 COMMENT '刪除標記',
    INDEX idx_tenant_code (tenant_code),
    INDEX idx_status (status),
    INDEX idx_expire_time (expire_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租戶表';
```

### 4.2 用戶表（sys_user）

**表說明**：存儲用戶賬號和基本信息

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| username | VARCHAR | 64 | NO | - | 用戶名 |
| password | VARCHAR | 255 | NO | - | 密碼（BCrypt加密） |
| real_name | VARCHAR | 64 | YES | - | 真實姓名 |
| nickname | VARCHAR | 64 | YES | - | 昵稱 |
| avatar | VARCHAR | 512 | YES | - | 頭像URL |
| email | VARCHAR | 100 | YES | - | 郵箱 |
| phone | VARCHAR | 20 | YES | - | 手機號 |
| user_type | VARCHAR | 32 | YES | 'NORMAL' | 用戶類型 |
| status | TINYINT | - | YES | 1 | 狀態 |
| last_login_time | DATETIME | - | YES | - | 最後登入時間 |
| last_login_ip | VARCHAR | 64 | YES | - | 最後登入IP |
| password_update_time | DATETIME | - | YES | - | 密碼修改時間 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |
| updated_by | BIGINT | - | YES | - | 更新人 |
| updated_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 更新時間 |
| deleted | TINYINT | - | YES | 0 | 刪除標記 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_tenant_username` (`tenant_id`, `username`)
- INDEX `idx_tenant_id` (`tenant_id`)
- INDEX `idx_email` (`email`)
- INDEX `idx_phone` (`phone`)
- INDEX `idx_status` (`status`)

**DDL語句**：

```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用戶ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    username VARCHAR(64) NOT NULL COMMENT '用戶名',
    password VARCHAR(255) NOT NULL COMMENT '密碼',
    real_name VARCHAR(64) COMMENT '真實姓名',
    nickname VARCHAR(64) COMMENT '昵稱',
    avatar VARCHAR(512) COMMENT '頭像URL',
    email VARCHAR(100) COMMENT '郵箱',
    phone VARCHAR(20) COMMENT '手機號',
    user_type VARCHAR(32) DEFAULT 'NORMAL' COMMENT '用戶類型',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    last_login_time DATETIME COMMENT '最後登入時間',
    last_login_ip VARCHAR(64) COMMENT '最後登入IP',
    password_update_time DATETIME COMMENT '密碼修改時間',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    deleted TINYINT DEFAULT 0 COMMENT '刪除標記',
    UNIQUE KEY uk_tenant_username (tenant_id, username),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用戶表';
```

### 4.3 角色表（sys_role）

**表說明**：存儲角色信息

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| role_code | VARCHAR | 64 | NO | - | 角色編碼 |
| role_name | VARCHAR | 128 | NO | - | 角色名稱 |
| description | VARCHAR | 512 | YES | - | 角色描述 |
| role_type | VARCHAR | 32 | YES | 'CUSTOM' | 角色類型 |
| role_level | INT | - | YES | 0 | 角色層級 |
| parent_id | BIGINT | YES | - | 父角色ID |
| data_scope | VARCHAR | 32 | YES | 'SELF' | 數據範圍 |
| status | TINYINT | - | YES | 1 | 狀態 |
| sort_order | INT | - | YES | 0 | 排序 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |
| updated_by | BIGINT | - | YES | - | 更新人 |
| updated_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 更新時間 |
| deleted | TINYINT | - | YES | 0 | 刪除標記 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_tenant_role_code` (`tenant_id`, `role_code`)
- INDEX `idx_tenant_id` (`tenant_id`)
- INDEX `idx_role_type` (`role_type`)
- INDEX `idx_parent_id` (`parent_id`)

**DDL語句**：

```sql
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    role_code VARCHAR(64) NOT NULL COMMENT '角色編碼',
    role_name VARCHAR(128) NOT NULL COMMENT '角色名稱',
    description VARCHAR(512) COMMENT '角色描述',
    role_type VARCHAR(32) DEFAULT 'CUSTOM' COMMENT '角色類型',
    role_level INT DEFAULT 0 COMMENT '角色層級',
    parent_id BIGINT COMMENT '父角色ID',
    data_scope VARCHAR(32) DEFAULT 'SELF' COMMENT '數據範圍',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    deleted TINYINT DEFAULT 0 COMMENT '刪除標記',
    UNIQUE KEY uk_tenant_role_code (tenant_id, role_code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_role_type (role_type),
    INDEX idx_parent_id (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

### 4.4 權限表（sys_permission）

**表說明**：存儲權限資源信息

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | YES | - | 租戶ID（NULL表示系統級） |
| permission_code | VARCHAR | 128 | NO | - | 權限編碼 |
| permission_name | VARCHAR | 128 | NO | - | 權限名稱 |
| description | VARCHAR | 512 | YES | - | 權限描述 |
| permission_type | VARCHAR | 32 | YES | 'API' | 權限類型 |
| category | VARCHAR | 64 | YES | - | 權限分類 |
| resource_type | VARCHAR | 32 | YES | - | 資源類型 |
| action | VARCHAR | 32 | YES | - | 操作 |
| api_path | VARCHAR | 256 | YES | - | API路徑 |
| api_method | VARCHAR | 16 | YES | - | HTTP方法 |
| parent_id | BIGINT | YES | - | 父權限ID |
| menu_url | VARCHAR | 256 | YES | - | 菜單URL |
| menu_icon | VARCHAR | 128 | YES | - | 菜單圖標 |
| status | TINYINT | - | YES | 1 | 狀態 |
| sort_order | INT | - | YES | 0 | 排序 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |
| updated_by | BIGINT | - | YES | - | 更新人 |
| updated_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 更新時間 |
| deleted | TINYINT | - | YES | 0 | 刪除標記 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_permission_code` (`permission_code`, `tenant_id`)
- INDEX `idx_tenant_id` (`tenant_id`)
- INDEX `idx_permission_type` (`permission_type`)
- INDEX `idx_resource_type` (`resource_type`)
- INDEX `idx_parent_id` (`parent_id`)

**DDL語句**：

```sql
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '權限ID',
    tenant_id BIGINT COMMENT '租戶ID',
    permission_code VARCHAR(128) NOT NULL COMMENT '權限編碼',
    permission_name VARCHAR(128) NOT NULL COMMENT '權限名稱',
    description VARCHAR(512) COMMENT '權限描述',
    permission_type VARCHAR(32) DEFAULT 'API' COMMENT '權限類型',
    category VARCHAR(64) COMMENT '權限分類',
    resource_type VARCHAR(32) COMMENT '資源類型',
    action VARCHAR(32) COMMENT '操作',
    api_path VARCHAR(256) COMMENT 'API路徑',
    api_method VARCHAR(16) COMMENT 'HTTP方法',
    parent_id BIGINT COMMENT '父權限ID',
    menu_url VARCHAR(256) COMMENT '菜單URL',
    menu_icon VARCHAR(128) COMMENT '菜單圖標',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    deleted TINYINT DEFAULT 0 COMMENT '刪除標記',
    UNIQUE KEY uk_permission_code (permission_code, tenant_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_permission_type (permission_type),
    INDEX idx_resource_type (resource_type),
    INDEX idx_parent_id (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='權限表';
```

#### ⚠️ 權限表設計優化建議

**潛在問題**：當前設計將`api_path`和`api_method`直接存儲在權限表中，這會導致：

1. API數量龐大時，權限表記錄數急劇增長
2. API路徑變更時，需要更新數據庫記錄
3. 數據庫與代碼緊密耦合，維護成本高

**推薦優化方案**：

**方案一：使用permission_code抽象（推薦）**

```java
// 1. 權限表中只存儲抽象的權限編碼
// sys_permission表：
// permission_code: "user:read"
// permission_code: "user:create"

// 2. 在配置文件或緩存中維護permission_code到API的映射
// application.yml或Redis
permission:
  mappings:
    "user:read":
      - path: "/api/v1/users"
        method: "GET"
      - path: "/api/v1/users/{id}"
        method: "GET"
    "user:create":
      - path: "/api/v1/users"
        method: "POST"

// 3. 在API層使用註解關聯
@RestController
public class UserController {
    
    @GetMapping("/api/v1/users")
    @RequiresPermissions("user:read")  // 直接使用permission_code
    public List<User> listUsers() {
        // ...
    }
}
```

**方案二：獨立API權限映射表**

```sql
-- 創建獨立的API權限映射表
CREATE TABLE sys_permission_api_mapping (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(128) NOT NULL COMMENT '權限編碼',
    api_path VARCHAR(256) NOT NULL COMMENT 'API路徑（支持Ant通配符）',
    api_method VARCHAR(16) NOT NULL COMMENT 'HTTP方法',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_permission_code (permission_code),
    INDEX idx_api_path (api_path)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='權限API映射表';

-- 示例數據
INSERT INTO sys_permission_api_mapping VALUES
(1, 'user:read', '/api/v1/users', 'GET', NOW()),
(2, 'user:read', '/api/v1/users/*', 'GET', NOW()),
(3, 'user:create', '/api/v1/users', 'POST', NOW());
```

**優勢對比**：

| 方面 | 當前方案 | 優化方案 |
|------|---------|----------|
| 維護成本 | 高（數據庫記錄） | 低（配置文件/獨立映射表） |
| 靈活性 | 低（需要變更數據） | 高（修改配置即可） |
| 性能 | 中（查詢權限表） | 高（內存緩存） |
| 耦合度 | 高（API與DB耦合） | 低（解耦） |
| 適用場景 | API數量少且穩定 | API數量多或頻繁變化 |

**實施建議**：

1. **小型項目**（< 100個API）：可保持當前設計
2. **中大型項目**（> 100個API）：建議採用方案一或方案二
3. **遷移策略**：保留`api_path`和`api_method`字段，新增配置層映射，逐步遷移

### 4.5 用戶角色關聯表（sys_user_role）

**表說明**：存儲用戶和角色的多對多關係

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| user_id | BIGINT | - | NO | - | 用戶ID |
| role_id | BIGINT | - | NO | - | 角色ID |
| effective_time | DATETIME | - | YES | - | 生效時間 |
| expire_time | DATETIME | - | YES | - | 過期時間 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_user_role` (`tenant_id`, `user_id`, `role_id`)
- INDEX `idx_user_id` (`user_id`)
- INDEX `idx_role_id` (`role_id`)
- INDEX `idx_tenant_id` (`tenant_id`)

**DDL語句**：

```sql
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    user_id BIGINT NOT NULL COMMENT '用戶ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    effective_time DATETIME COMMENT '生效時間',
    expire_time DATETIME COMMENT '過期時間',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    UNIQUE KEY uk_user_role (tenant_id, user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用戶角色關聯表';
```

### 4.6 角色權限關聯表（sys_role_permission）

**表說明**：存儲角色和權限的多對多關係

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| role_id | BIGINT | - | NO | - | 角色ID |
| permission_id | BIGINT | - | NO | - | 權限ID |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_role_permission` (`tenant_id`, `role_id`, `permission_id`)
- INDEX `idx_role_id` (`role_id`)
- INDEX `idx_permission_id` (`permission_id`)
- INDEX `idx_tenant_id` (`tenant_id`)

**DDL語句**：

```sql
CREATE TABLE sys_role_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    permission_id BIGINT NOT NULL COMMENT '權限ID',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    UNIQUE KEY uk_role_permission (tenant_id, role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色權限關聯表';
```

### 4.7 部門表（sys_department）

**表說明**：存儲組織架構部門信息

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| parent_id | BIGINT | YES | 0 | 父部門ID |
| dept_code | VARCHAR | 64 | NO | - | 部門編碼 |
| dept_name | VARCHAR | 128 | NO | - | 部門名稱 |
| dept_path | VARCHAR | 512 | YES | - | 部門路徑 |
| manager_id | BIGINT | YES | - | 部門負責人ID |
| phone | VARCHAR | 20 | YES | - | 聯繫電話 |
| email | VARCHAR | 100 | YES | - | 郵箱 |
| level | INT | - | YES | 1 | 部門層級 |
| sort_order | INT | - | YES | 0 | 排序 |
| status | TINYINT | - | YES | 1 | 狀態 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |
| updated_by | BIGINT | - | YES | - | 更新人 |
| updated_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 更新時間 |
| deleted | TINYINT | - | YES | 0 | 刪除標記 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_tenant_dept_code` (`tenant_id`, `dept_code`)
- INDEX `idx_tenant_id` (`tenant_id`)
- INDEX `idx_parent_id` (`parent_id`)
- INDEX `idx_dept_path` (`dept_path`)

**DDL語句**：

```sql
CREATE TABLE sys_department (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '部門ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    parent_id BIGINT DEFAULT 0 COMMENT '父部門ID',
    dept_code VARCHAR(64) NOT NULL COMMENT '部門編碼',
    dept_name VARCHAR(128) NOT NULL COMMENT '部門名稱',
    dept_path VARCHAR(512) COMMENT '部門路徑',
    manager_id BIGINT COMMENT '部門負責人ID',
    phone VARCHAR(20) COMMENT '聯繫電話',
    email VARCHAR(100) COMMENT '郵箱',
    level INT DEFAULT 1 COMMENT '部門層級',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    deleted TINYINT DEFAULT 0 COMMENT '刪除標記',
    UNIQUE KEY uk_tenant_dept_code (tenant_id, dept_code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_dept_path (dept_path)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部門表';
```

### 4.8 用戶部門關聯表（sys_user_department）

**表說明**：存儲用戶和部門的多對多關係

| 字段名 | 類型 | 長度 | 允許NULL | 默認值 | 說明 |
|-------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主鍵 |
| tenant_id | BIGINT | - | NO | - | 租戶ID |
| user_id | BIGINT | - | NO | - | 用戶ID |
| department_id | BIGINT | - | NO | - | 部門ID |
| is_primary | TINYINT | - | YES | 0 | 是否主部門 |
| created_by | BIGINT | - | YES | - | 創建人 |
| created_at | DATETIME | - | YES | CURRENT_TIMESTAMP | 創建時間 |

**索引設計**：

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_user_dept` (`tenant_id`, `user_id`, `department_id`)
- INDEX `idx_user_id` (`user_id`)
- INDEX `idx_department_id` (`department_id`)
- INDEX `idx_tenant_id` (`tenant_id`)

**DDL語句**：

```sql
CREATE TABLE sys_user_department (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    user_id BIGINT NOT NULL COMMENT '用戶ID',
    department_id BIGINT NOT NULL COMMENT '部門ID',
    is_primary TINYINT DEFAULT 0 COMMENT '是否主部門',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    UNIQUE KEY uk_user_dept (tenant_id, user_id, department_id),
    INDEX idx_user_id (user_id),
    INDEX idx_department_id (department_id),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用戶部門關聯表';
```

## 5. 擴展表設計

### 5.1 角色數據權限範圍表（sys_role_data_scope）

**表說明**：存儲角色的自定義數據權限範圍

```sql
CREATE TABLE sys_role_data_scope (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    scope_type VARCHAR(32) NOT NULL COMMENT '範圍類型：DEPARTMENT/USER',
    scope_value BIGINT NOT NULL COMMENT '範圍值：部門ID/用戶ID',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    INDEX idx_role_id (role_id),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色數據權限範圍表';
```

### 5.2 用戶臨時權限表（sys_user_permission_temp）

**表說明**：存儲用戶的臨時授權

```sql
CREATE TABLE sys_user_permission_temp (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    user_id BIGINT NOT NULL COMMENT '用戶ID',
    permission_id BIGINT NOT NULL COMMENT '權限ID',
    effective_time DATETIME NOT NULL COMMENT '生效時間',
    expire_time DATETIME NOT NULL COMMENT '過期時間',
    reason VARCHAR(512) COMMENT '授權原因',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    INDEX idx_user_id (user_id),
    INDEX idx_expire_time (expire_time),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用戶臨時權限表';
```

### 5.3 權限申請表（sys_permission_application）

**表說明**：存儲權限申請記錄

```sql
CREATE TABLE sys_permission_application (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    tenant_id BIGINT NOT NULL COMMENT '租戶ID',
    applicant_id BIGINT NOT NULL COMMENT '申請人ID',
    apply_type VARCHAR(32) NOT NULL COMMENT '申請類型：ROLE/PERMISSION',
    apply_target_id BIGINT NOT NULL COMMENT '申請目標ID',
    apply_reason VARCHAR(512) COMMENT '申請原因',
    status VARCHAR(32) DEFAULT 'PENDING' COMMENT '狀態：PENDING/APPROVED/REJECTED',
    approver_id BIGINT COMMENT '審批人ID',
    approve_time DATETIME COMMENT '審批時間',
    approve_comment VARCHAR(512) COMMENT '審批意見',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    INDEX idx_applicant (applicant_id),
    INDEX idx_status (status),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='權限申請表';
```

## 6. 審計與日誌表

### 6.1 審計日誌表（sys_audit_log）

**表說明**：存儲系統操作審計日誌

```sql
CREATE TABLE sys_audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日誌ID',
    tenant_id BIGINT COMMENT '租戶ID',
    user_id BIGINT COMMENT '用戶ID',
    username VARCHAR(64) COMMENT '用戶名',
    
    -- 操作信息
    operation_type VARCHAR(32) COMMENT '操作類型：CREATE/UPDATE/DELETE/LOGIN/LOGOUT',
    operation_module VARCHAR(64) COMMENT '操作模塊',
    operation_desc VARCHAR(512) COMMENT '操作描述',
    
    -- 請求信息
    request_method VARCHAR(16) COMMENT '請求方法',
    request_url VARCHAR(512) COMMENT '請求URL',
    request_params TEXT COMMENT '請求參數',
    request_ip VARCHAR(64) COMMENT '請求IP',
    user_agent VARCHAR(512) COMMENT '用戶代理',
    
    -- 響應信息
    response_status INT COMMENT '響應狀態碼',
    response_time BIGINT COMMENT '響應時間(毫秒)',
    error_msg TEXT COMMENT '錯誤信息',
    
    -- 審計信息
    trace_id VARCHAR(64) COMMENT '追蹤ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_created_at (created_at),
    INDEX idx_trace_id (trace_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='審計日誌表';
```

### 6.2 登入日誌表（sys_login_log）

**表說明**：存儲用戶登入日誌

```sql
CREATE TABLE sys_login_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日誌ID',
    tenant_id BIGINT COMMENT '租戶ID',
    user_id BIGINT COMMENT '用戶ID',
    username VARCHAR(64) COMMENT '用戶名',
    
    -- 登入信息
    login_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '登入時間',
    login_ip VARCHAR(64) COMMENT '登入IP',
    login_location VARCHAR(128) COMMENT '登入地點',
    browser VARCHAR(64) COMMENT '瀏覽器',
    os VARCHAR(64) COMMENT '操作系統',
    
    -- 登入結果
    status TINYINT COMMENT '登入狀態：0-失敗 1-成功',
    login_type VARCHAR(32) COMMENT '登入類型：PASSWORD/SMS/SSO',
    fail_reason VARCHAR(256) COMMENT '失敗原因',
    
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_login_time (login_time),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登入日誌表';
```

## 7. 配置表設計

### 7.1 系統配置表（sys_config）

**表說明**：存儲系統配置參數

```sql
CREATE TABLE sys_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
    tenant_id BIGINT COMMENT '租戶ID（NULL表示系統配置）',
    config_key VARCHAR(128) NOT NULL COMMENT '配置鍵',
    config_value TEXT COMMENT '配置值',
    config_type VARCHAR(32) COMMENT '配置類型：STRING/NUMBER/BOOLEAN/JSON',
    category VARCHAR(64) COMMENT '配置分類',
    description VARCHAR(512) COMMENT '配置描述',
    is_system TINYINT DEFAULT 0 COMMENT '是否系統配置',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    UNIQUE KEY uk_tenant_config_key (tenant_id, config_key),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_category (category)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系統配置表';
```

### 7.2 字典表（sys_dict）

**表說明**：存儲系統字典數據

```sql
CREATE TABLE sys_dict (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '字典ID',
    tenant_id BIGINT COMMENT '租戶ID',
    dict_type VARCHAR(64) NOT NULL COMMENT '字典類型',
    dict_label VARCHAR(128) NOT NULL COMMENT '字典標籤',
    dict_value VARCHAR(128) NOT NULL COMMENT '字典值',
    dict_sort INT DEFAULT 0 COMMENT '排序',
    parent_id BIGINT DEFAULT 0 COMMENT '父字典ID',
    status TINYINT DEFAULT 1 COMMENT '狀態',
    remark VARCHAR(512) COMMENT '備註',
    created_by BIGINT COMMENT '創建人',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '創建時間',
    updated_by BIGINT COMMENT '更新人',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新時間',
    INDEX idx_dict_type (dict_type),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典表';
```

## 8. 數據初始化腳本

### 8.1 默認租戶數據

```sql
-- 插入平台管理租戶
INSERT INTO sys_tenant (tenant_code, tenant_name, package_type, max_users, status) 
VALUES ('PLATFORM', '平台管理', 'ENTERPRISE', 999999, 1);
```

### 8.2 默認角色數據

```sql
-- 插入系統預置角色
INSERT INTO sys_role (tenant_id, role_code, role_name, role_type, data_scope, status) 
VALUES 
(1, 'PLATFORM_ADMIN', '平台超級管理員', 'SYSTEM', 'ALL', 1),
(1, 'TENANT_ADMIN', '租戶管理員', 'SYSTEM', 'TENANT', 1),
(1, 'DEPT_ADMIN', '部門管理員', 'SYSTEM', 'DEPT', 1),
(1, 'NORMAL_USER', '普通用戶', 'SYSTEM', 'SELF', 1);
```

### 8.3 默認權限數據

```sql
-- 插入系統預置權限
INSERT INTO sys_permission (permission_code, permission_name, permission_type, resource_type, action, status) 
VALUES 
-- 用戶管理
('user:create', '創建用戶', 'API', 'USER', 'CREATE', 1),
('user:read', '查看用戶', 'API', 'USER', 'READ', 1),
('user:update', '更新用戶', 'API', 'USER', 'UPDATE', 1),
('user:delete', '刪除用戶', 'API', 'USER', 'DELETE', 1),

-- 角色管理
('role:create', '創建角色', 'API', 'ROLE', 'CREATE', 1),
('role:read', '查看角色', 'API', 'ROLE', 'READ', 1),
('role:update', '更新角色', 'API', 'ROLE', 'UPDATE', 1),
('role:delete', '刪除角色', 'API', 'ROLE', 'DELETE', 1),

-- 權限管理
('permission:read', '查看權限', 'API', 'PERMISSION', 'READ', 1),
('permission:assign', '分配權限', 'API', 'PERMISSION', 'ASSIGN', 1);
```

## 9. 數據庫優化建議

### 9.1 索引優化

1. **覆蓋索引**：常用查詢字段創建聯合索引
2. **前綴索引**：長文本字段使用前綴索引
3. **避免冗餘索引**：定期清理未使用的索引
4. **監控索引使用**：使用 `EXPLAIN` 分析查詢計劃

### 9.2 查詢優化

```sql
-- 優化前：N+1查詢問題
SELECT * FROM sys_user WHERE tenant_id = ?;
-- 然後循環查詢每個用戶的角色

-- 優化後：使用JOIN一次查詢
SELECT u.*, r.role_name
FROM sys_user u
LEFT JOIN sys_user_role ur ON u.id = ur.user_id
LEFT JOIN sys_role r ON ur.role_id = r.id
WHERE u.tenant_id = ? AND u.status = 1;
```

### 9.3 分區表（大數據量場景）

```sql
-- 按時間分區審計日誌表
CREATE TABLE sys_audit_log (
    -- 字段定義
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 9.4 讀寫分離

```
主庫（Master）
   │
   ├─ 寫操作
   │
   └─ 同步
       ↓
從庫（Slave）
   │
   └─ 讀操作
```

## 10. 數據備份策略

### 10.1 備份方案

| 備份類型 | 頻率 | 保留時間 | 說明 |
|---------|------|---------|------|
| 全量備份 | 每週 | 4週 | 完整數據庫備份 |
| 增量備份 | 每天 | 7天 | 自上次備份後的變更 |
| 二進制日誌 | 實時 | 7天 | 用於點對點恢復 |

### 10.2 備份腳本

```bash
#!/bin/bash
# 數據庫備份腳本

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="rbac_system"

# 全量備份
mysqldump -u root -p${PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  ${DB_NAME} > ${BACKUP_DIR}/full_${DATE}.sql

# 壓縮備份文件
gzip ${BACKUP_DIR}/full_${DATE}.sql

# 刪除7天前的備份
find ${BACKUP_DIR} -name "full_*.sql.gz" -mtime +7 -delete
```

## 11. 數據字典完整導出

### 11.1 表清單

| 序號 | 表名 | 中文名 | 說明 |
|-----|------|-------|------|
| 1 | sys_tenant | 租戶表 | 存儲租戶基本信息 |
| 2 | sys_user | 用戶表 | 存儲用戶賬號信息 |
| 3 | sys_role | 角色表 | 存儲角色信息 |
| 4 | sys_permission | 權限表 | 存儲權限資源 |
| 5 | sys_user_role | 用戶角色關聯表 | 用戶角色多對多關係 |
| 6 | sys_role_permission | 角色權限關聯表 | 角色權限多對多關係 |
| 7 | sys_department | 部門表 | 存儲組織架構 |
| 8 | sys_user_department | 用戶部門關聯表 | 用戶部門多對多關係 |
| 9 | sys_role_data_scope | 角色數據權限範圍表 | 自定義數據權限 |
| 10 | sys_user_permission_temp | 用戶臨時權限表 | 臨時授權記錄 |
| 11 | sys_permission_application | 權限申請表 | 權限申請審批 |
| 12 | sys_audit_log | 審計日誌表 | 操作審計日誌 |
| 13 | sys_login_log | 登入日誌表 | 用戶登入記錄 |
| 14 | sys_config | 系統配置表 | 系統配置參數 |
| 15 | sys_dict | 字典表 | 系統字典數據 |

## 12. 總結

本數據庫設計文檔提供了多租戶RBAC系統的完整數據模型，包括：

1. **核心實體表**：租戶、用戶、角色、權限、部門
2. **關聯關係表**：用戶角色、角色權限、用戶部門
3. **擴展功能表**：數據權限、臨時授權、權限申請
4. **審計日誌表**：操作審計、登入日誌
5. **配置管理表**：系統配置、字典數據

所有表設計遵循最佳實踐：

- 租戶隔離設計
- 軟刪除機制
- 完整的審計字段
- 合理的索引設計
- 擴展性考慮

數據庫設計支持從小規模到大規模的應用場景，並提供了優化和擴展方案。
